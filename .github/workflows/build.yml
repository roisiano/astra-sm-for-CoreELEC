name: Build Astra-sm for CoreELEC (aarch64)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-astra-sm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Aarch64 Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu make pkg-config

    - name: Install Dependencies
      run: |
        sudo apt-get install -y cmake git build-essential

    - name: Clonar astra-sm
      run: |
        git clone https://github.com/crazycat69/astra-sm.git
        cd astra-sm

    - name: Build Astra-sm
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../Toolchain-aarch64.cmake
        make

    - name: Package Astra-sm into .ipk
      run: |
        cd build
        mkdir -p package/DEBIAN
        echo "Package: astra-sm" > package/DEBIAN/control
        echo "Version: 1.0" >> package/DEBIAN/control
        echo "Architecture: aarch64" >> package/DEBIAN/control
        echo "Maintainer: YourName" >> package/DEBIAN/control
        echo "Description: Astra-sm for CoreELEC" >> package/DEBIAN/control
        mkdir -p package/usr/bin
        cp astra-sm package/usr/bin/
        dpkg-deb --build package astra-sm_aarch64.ipk

    - name: Upload the IPK artifact
      uses: actions/upload-artifact@v3
      with:
        name: astra-sm_aarch64.ipk
        path: build/astra-sm_aarch64.ipk
