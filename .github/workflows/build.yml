name: Build Astra-sm for CoreELEC (aarch64)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-astra-sm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Aarch64 Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu make pkg-config autoconf automake libtool
    - name: Install Dependencies
      run: |
        sudo apt-get install -y git build-essential
    - name: Clonar astra-sm
      run: |
        git clone https://github.com/crazycat69/astra-sm.git
        cd astra-sm
        ls -alh  # Listar archivos para ver la estructura
    - name: Preparar sistema de compilación con Autoconf y Automake
      run: |
        cd astra-sm
        ./autogen.sh  # Generar los archivos de configuración con Autoconf
        ./configure    # Configurar el entorno de construcción
    - name: Compilar astra-sm
      run: |
        cd astra-sm
        make ARCH=aarch64 CROSS_COMPILE=aarch64-linux-gnu-
    - name: Package Astra-sm into .ipk
      run: |
        cd astra-sm
        mkdir -p package/DEBIAN
        echo "Package: astra-sm" > package/DEBIAN/control
        echo "Version: 1.0" >> package/DEBIAN/control
        echo "Architecture: aarch64" >> package/DEBIAN/control
        echo "Maintainer: YourName" >> package/DEBIAN/control
        echo "Description: Astra-sm for CoreELEC" >> package/DEBIAN/control
        mkdir -p package/usr/bin
        cp src/astra/astra package/usr/bin/ || echo "No binary found, skipping"
        dpkg-deb --build package astra-sm_aarch64.ipk
    - name: Upload the IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: astra-sm_aarch64.ipk
        path: astra-sm/aarch64.ipk

